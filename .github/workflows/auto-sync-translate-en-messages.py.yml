on:
  push:
    branches: [master, main]
    paths: '**/translate-en-messages.py'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Init target repos
        id: init_repos
        run: |
          target_repos=("adamlui/userscripts" "adamlui/chatgpt-apps" "adamlui/autoclear-chatgpt-history" "adamlui/chatgpt-auto-continue" "adamlui/chatgpt-auto-refresh" "adamlui/chatgpt-infinity" "adamlui/chatgpt-widescreen" "adamlui/youtube-classic" "kudoai/bravegpt" "kudoai/duckduckgpt")
          echo "::set-output name=repos::${target_repos[*]}"

      - name: Checkout adamlui/python-utils
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.REPO_SYNC_PAT }}
          repository: adamlui/python-utils
          path: adamlui/python-utils
          fetch-depth: 2

      - name: Checkout target repos
        run: |
          target_repos=(${{ steps.init_repos.outputs.repos }})
          for repo in "${target_repos[@]}"; do
            repo_path=$(echo "$repo" | sed 's#/#_#g')
            echo "::group::Checking out $repo"
            git clone https://github.com/$repo.git $GITHUB_WORKSPACE/$repo_path
            cd $GITHUB_WORKSPACE/$repo_path
            git fetch --depth=2 origin # Fetching with a deeper history
            git remote set-url --push origin https://auto-sync-bot:$GITHUB_TOKEN@github.com/$repo
            echo "::endgroup::"
          done

      - name: Replace outdated translate-en-messages.py in target repos
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_SYNC_PAT }}
        run: |
          target_repos=(${{ steps.init_repos.outputs.repos }})

          source_file="${{ github.workspace }}/adamlui/python-utils/translate-messages/translate-en-messages.py"
          source_timestamp=$(git log -1 --format="%ct" -- "$source_file")

          for repo in "${target_repos[@]}"; do
            if [[ "$repo" != "adamlui/python-utils" ]]; then
              echo "::group::Replacing translate-en-messages.py in $repo"
              repo_path=$(echo "$repo" | sed 's/\//_/g')
              cd $GITHUB_WORKSPACE/$repo_path

              target_files=$(find . -name "translate-en-messages.py" -type f)

              for target_file in $target_files; do
                target_timestamp=$(git log -1 --format="%ct" -- "$target_file")

                if [[ $source_timestamp -gt $target_timestamp ]]; then
                  cp -f "$source_file" "$target_file"
                  git add "$target_file"
                fi
              done

              git diff-index --quiet HEAD || git commit -m "${{ github.event.head_commit.message }} â†ž [auto-sync from `adamlui/python-utils`]" --author "auto-sync@kudoai.com" && git push --force
              echo "::endgroup::"
            fi
          done
